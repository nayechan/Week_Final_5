#!/usr/bin/env python3
"""
Mundi Engine - Lua ë°”ì¸ë”© ìë™ ìƒì„± ë„êµ¬

UPROPERTYì™€ UFUNCTION ë§¤í¬ë¡œë¥¼ íŒŒì‹±í•˜ì—¬
.generated.cpp íŒŒì¼ì„ ìë™ ìƒì„±í•©ë‹ˆë‹¤.

ì‚¬ìš©ë²•:
    python generate.py --source-dir <ì†ŒìŠ¤ ë””ë ‰í† ë¦¬> --output-dir <ì¶œë ¥ ë””ë ‰í† ë¦¬>
"""

import argparse
import sys
from pathlib import Path
from parser import HeaderParser
from property_generator import PropertyGenerator
from lua_generator import LuaBindingGenerator


GENERATED_FILE_TEMPLATE = """// Auto-generated file - DO NOT EDIT!
// Generated by Tools/CodeGenerator/generate.py

#include "{header_include}"
#include "Core/Object/ObjectMacros.h"
#include "Engine/Scripting/LuaBindHelpers.h"

// ===== Property Reflection =====
{property_code}

// ===== Lua Binding =====
{lua_code}
"""


def generate_code_for_class(class_info, prop_gen, lua_gen):
    """í´ë˜ìŠ¤ì— ëŒ€í•œ ì™„ì „í•œ .generated.cpp íŒŒì¼ ìƒì„±"""
    # í—¤ë” íŒŒì¼ ìƒëŒ€ ê²½ë¡œ ê³„ì‚°
    header_include = class_info.header_file.name

    # í”„ë¡œí¼í‹° ì½”ë“œ ìƒì„±
    property_code = prop_gen.generate(class_info)

    # Lua ë°”ì¸ë”© ì½”ë“œ ìƒì„±
    lua_code = lua_gen.generate(class_info)

    # ìµœì¢… íŒŒì¼ ë‚´ìš©
    return GENERATED_FILE_TEMPLATE.format(
        header_include=header_include,
        property_code=property_code,
        lua_code=lua_code
    )


def main():
    parser = argparse.ArgumentParser(
        description='Mundi Engine Lua Binding Auto-Generator'
    )
    parser.add_argument(
        '--source-dir',
        type=Path,
        required=True,
        help='ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ê²½ë¡œ (ì˜ˆ: Source/Runtime)'
    )
    parser.add_argument(
        '--output-dir',
        type=Path,
        required=True,
        help='ìƒì„±ëœ íŒŒì¼ ì¶œë ¥ ë””ë ‰í† ë¦¬ (ì˜ˆ: Build/Generated)'
    )

    args = parser.parse_args()

    # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
    if not args.source_dir.exists():
        print(f"âŒ Error: Source directory not found: {args.source_dir}")
        sys.exit(1)

    # ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    args.output_dir.mkdir(parents=True, exist_ok=True)

    print("=" * 60)
    print("ğŸ”¨ Mundi Engine - Code Generator")
    print("=" * 60)
    print(f"ğŸ“ Source: {args.source_dir}")
    print(f"ğŸ“ Output: {args.output_dir}")
    print()

    # íŒŒì„œ ì´ˆê¸°í™”
    header_parser = HeaderParser()
    prop_gen = PropertyGenerator()
    lua_gen = LuaBindingGenerator()

    # í—¤ë” íŒŒì¼ ìŠ¤ìº”
    print("ğŸ” Scanning for reflection classes...")
    classes = header_parser.find_reflection_classes(args.source_dir)

    if not classes:
        print("âš ï¸  No classes with GENERATED_REFLECTION_BODY() found.")
        return

    print(f"\nâœ… Found {len(classes)} reflection class(es)\n")

    # ê° í´ë˜ìŠ¤ì— ëŒ€í•´ .generated.cpp ìƒì„±
    generated_files = []
    for class_info in classes:
        output_file = args.output_dir / f"{class_info.name}.generated.cpp"

        # ì½”ë“œ ìƒì„±
        generated_code = generate_code_for_class(class_info, prop_gen, lua_gen)

        # íŒŒì¼ ì“°ê¸°
        output_file.write_text(generated_code, encoding='utf-8')
        generated_files.append(output_file)

        print(f"âœ“ Generated: {output_file.name}")
        print(f"  â”œâ”€ Properties: {len(class_info.properties)}")
        print(f"  â””â”€ Functions:  {len([f for f in class_info.functions if f.metadata.get('lua_bind')])}")

    print()
    print("=" * 60)
    print(f"âœ… Code generation complete! ({len(generated_files)} files)")
    print("=" * 60)


if __name__ == '__main__':
    main()
